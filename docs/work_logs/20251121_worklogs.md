# 工作日誌 - 2025-11-21

## Quality Critic API 開發與資料庫整合

### 一、核心功能實作

#### 1. 評估模式設計
- **Quick Mode**: 僅執行 Overall 評估，節省成本（60-80% API 調用成本）
- **Comprehensive Mode**: Overall + 所有題目評估 + 統計分析

#### 2. API Endpoint 開發
- **路徑**: `POST /api/v1/testing/critic/evaluate_by_job`
- **功能**:
  - 透過 `job_id` 從資料庫取得生成內容
  - 自動合併多種題型（multiple_choice, short_answer, true_false）
  - 全局題號重編
  - 透過 retriever agent 取得 RAG 上下文
  - 執行 Quality Critic 評估
  - 自動存入資料庫

#### 3. 資料庫結構優化
**執行 Alembic 遷移** (`a1b2c3d4e5f6_improve_task_evaluations_schema`):
- 新增 `job_id` 欄位（FK to ORCHESTRATION_JOBS）
- 新增 `evaluation_mode` 欄位（exam_quick, exam_comprehensive, etc.）
- `feedback_for_generator`: TEXT → JSONB（結構化反饋給 revise agent）
- `metric_details`: JSON → JSONB（統計數據給實驗分析）
- 移除冗餘的 `critic_type` 欄位
- 創建索引提升查詢效能

### 二、架構優化

#### 1. EvaluationFormatter 層設計
創建 `critic_formatters.py` 實作關注點分離：

**`for_revise_agent()`** - 行動導向修改指令:
```json
{
  "revision_required": true,
  "failed_criteria_summary": ["Understandable"],
  "revision_instructions": [
    {
      "target": "overall",
      "issues": [
        {
          "criterion": "Understandable",
          "problem": "題目未充分解釋專業術語",
          "action": "加入術語定義 | 提供更多上下文"
        }
      ]
    }
  ]
}
```

**`for_metrics()`** - 純統計數據:
```json
{
  "mode": "quick",
  "is_passed": false,
  "scores": {"overall": {...}, "avg": 4.2},
  "failed_criteria": ["Understandable"],
  "duration_ms": 5678,
  "pass_rate_by_criterion": {...}  // comprehensive only
}
```

**`for_frontend()`** - 最小化 UI 數據:
```json
{
  "is_passed": false,
  "summary": {...},
  "overall_evaluation": [...]
}
```

#### 2. RAG 檢索邏輯修復
- 實作 `get_rag_chunks_by_job_id()`: 透過 job_id 找 retriever agent 的文件片段
- 修正資料檢索邏輯，成功取得 RAG context

### 三、資料儲存策略

#### TASK_EVALUATIONS 表儲存內容:
1. **feedback_for_generator** (JSONB):
   - 給 revise agent 使用
   - 包含修改指令（問題描述 + 具體行動）
   - 按 target 分組（overall / question_N）

2. **metric_details** (JSONB):
   - 給數據分析/實驗使用
   - 純統計數據（分數、平均值、通過率）
   - Comprehensive 模式包含每題通過率

3. **完整評估結果** 存於 `AGENT_TASKS.output`

### 四、修復問題

1. SQLAlchemy Boolean 檢查錯誤（3 處修復）
2. `get_llm()` 函數調用參數錯誤
3. `QualityCritic` 初始化參數錯誤
4. 移除 API 的 `save_to_db` 參數（改為一定存入資料庫）

### 五、檔案變更清單

**新增檔案**:
- `backend/app/agents/teacher_agent/critics/critic_formatters.py`
- `db_migrations/versions/a1b2c3d4e5f6_improve_task_evaluations_schema.py`

**修改檔案**:
- `backend/api_server.py` - 新增 `/evaluate_by_job` endpoint
- `backend/app/agents/teacher_agent/critics/quality_critic.py` - 新增 mode 參數
- `backend/app/agents/teacher_agent/critics/critic_db_utils.py` - 更新資料庫函數
- `docs/db_schema.md` - 更新 TASK_EVALUATIONS schema

### 六、技術亮點

1. **成本優化**: Quick mode 節省 60-80% API 成本
2. **關注點分離**: Formatter 層解耦資料轉換邏輯
3. **資料結構化**: JSONB 格式便於 revise agent 和數據分析
4. **可擴展性**: 支援未來新增評估模式（summary_quick, etc.）
5. **查詢效能**: 新增索引提升資料庫查詢速度

### 七、下一步（待測試）

- [ ] 測試 quick mode (job_id 268)
- [ ] 測試 comprehensive mode (job_id 268)
- [ ] 驗證資料庫儲存格式
- [ ] 整合到 LangGraph revise node

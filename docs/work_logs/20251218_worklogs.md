# Work Log - 2025/12/18

## 碩論系統 - RAG 優化與 Vision LLM 整合

### 1. RAG Debug API 規劃
- 設立 Retrieval 與 Full (包含 Ragas) 兩個 CheckPoint
- 新增端點：`/api/v1/testing/test_rag_retrieval` 和 `/api/v1/testing/test_rag_full_pipeline`
- 整合至 `teacher_testing_router.py`

### 2. OCR 移除 + Vision LLM 導入
**與 Chris 學長討論後決定**：移除 OCR 文字提取，僅保留 Vision LLM 圖片描述

**刪除內容**：
- `backend/app/services/ocr/` 整個目錄
- `backend/app/services/document_loader/ocr_utils.py`
- 從 `requirements.txt` 和 venv 移除：`opencv-contrib-python`, `paddlepaddle`, `paddlex`, `pytesseract`, `pyclipper`

**新增/修改**：
- 新增 `vision_utils.py` - 純 Vision LLM 處理
- 修改 `gpt4_vision.py` - 返回 dict 含 tokens 和 cost
- 更新所有 5 個 loaders（PDF/PPTX/DOCX/Image/Web）使用 Vision LLM

### 3. Vision LLM 成本記錄
- 在 ingestion 完成後創建聚合的 `vision_llm` 任務
- 記錄欄位：`model_name`, `estimated_cost_usd`, `prompt_tokens`, `output`
- 支援查詢總成本和每張圖片平均成本

### 4. Vision LLM Prompt 微調
**任務優先級**：
1. **首要任務**：完整文字提取（標題、正文、標註、表格結構）
2. **次要任務**：描述重要關係（流程圖/架構圖/圖表）

**輸出格式**：使用 HTML-style 標記
```
<圖片描述>
[標題] ...
1. ...
2. ...

關係說明直接寫出，不加中括號
</圖片描述>
```

---

## 修改的檔案清單

### 新增
- `backend/app/services/document_loader/vision_utils.py`

### 修改
- `backend/app/services/vision/gpt4_vision.py`
- `backend/app/services/document_loader/image_loader.py`
- `backend/app/services/document_loader/pdf_loader.py`
- `backend/app/services/document_loader/pptx_loader.py`
- `backend/app/services/document_loader/docx_loader.py`
- `backend/app/services/document_loader/web_loader.py`
- `backend/app/agents/teacher_agent/ingestion.py`
- `backend/app/services/text_splitter.py`
- `backend/app/routers/teacher_testing_router.py`
- `requirements.txt`

### 刪除
- `backend/app/services/ocr/` (整個目錄)
- `backend/app/services/document_loader/ocr_utils.py`
- `backend/app/routers/rag_debug_router.py` (已合併至 teacher_testing_router)

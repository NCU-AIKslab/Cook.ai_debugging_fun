# 工作日誌 - 2025/12/29

## 主題：Critic Agent 優化與 API 重構

---

## 重大變更：Fact Critic 指標調整

### 移除：Answer Relevancy
- **原因**：
  - 不適用於生成式任務（如出題、摘要）
  - 容易產生 JSON 解析錯誤
  - 與 Faithfulness 部分重疊
- **影響檔案**：`fact_critic.py`, `graph.py`, `test_fact_critic.py`

### 新增：TaskSatisfaction
- **用途**：評估生成內容是否符合使用者要求
- **檢查項目**：
  - `question_count`：題目數量是否正確
  - `question_type`：題型是否符合要求
  - `has_options`：選擇題是否有選項
  - `has_correct_answer`：是否有正確答案
  - `has_source`：是否有來源引用
- **分數**：加權計算後轉為 1-5 分
- **題型解析**：混合式（規則式 + LLM Fallback）

---

## 完成事項

### 1. 修復 Async 錯誤
- **問題**：`/chat` API 呼叫 graph 時出現 "No synchronous function provided to quality_critic"
- **原因**：使用 `run_in_threadpool(app.invoke, ...)` 但 graph 有 async nodes
- **修復**：改用 `await teacher_agent_app.ainvoke(inputs)`

### 2. 更新 `/chat` API
- 新增 `critic_workflow` 參數 (1-4)
  - 1: no_critic
  - 2: fact_only
  - 3: quality_only
  - 4: fact_then_quality
- 新增 `mode` 和 `max_iterations` 參數
- Response 包含完整 `evaluation` 結果

### 3. 重構 `/evaluate` API
- `/critic/evaluate_by_job` → `/evaluate`
- 整合 Fact Critic (Faithfulness + TaskSatisfaction)
- 整合 Quality Critic (G-Eval)
- 支援 workflow 2-4

### 4. TaskSatisfaction 優化
- 修復是非題 `question_type` 識別問題
- 新增「填空題」題型識別
- 實作混合式題型解析 (Rules + LLM Fallback)
- 追蹤 LLM 成本到資料庫

### 5. 清理與優化
- 移除冗餘 debug logs
- 修復 `overall_passed` 計算邏輯

---

## 修改檔案

| 檔案 | 變更 |
|------|------|
| `teacher_agent_router.py` | 新增 CRITIC_WORKFLOW_MAP, 更新 ChatRequest/EvaluateRequest |
| `graph.py` | 使用 ainvoke, 更新 run_fact_critic |
| `fact_critic.py` | 混合式 _parse_requirements, 新增 LLM fallback |
| `teacher_testing_router.py` | 清理 logs, 修復 overall_passed |

---

## 待辦事項

1. 根據實驗數據調整 Faithfulness 分數轉換
2. 微調 TaskSatisfaction 權重
3. 優化 Quality Critic Rubric (可配置化)
